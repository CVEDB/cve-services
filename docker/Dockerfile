FROM node:14-alpine3.12

LABEL \
    mitre.name=cveawg \
    mitre.project=cveawg \
    mitre.maintainer=mbianchi@mitre.org

# Install python/pip (required for argon2 build from source)
ENV PYTHONUNBUFFERED=1
RUN apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
RUN python3 -m ensurepip
RUN pip3 install --no-cache --upgrade pip setuptools

# Install build essentials (also required for argon2)
RUN apk add --update --no-cache build-base

# Set up directory to run as node user rather than root
ADD . /home/node/app
RUN chown -R node:node /home/node

WORKDIR /home/node/app

# Run as the node user rather than root
USER node

# include the package lock so the node install "honors" it
COPY --chown=node:node package-lock.json /home/node/app
COPY --chown=node:node package.json /home/node/app

RUN npm install --production
COPY --chown=node:node api-docs /home/node/app/api-docs
COPY --chown=node:node src /home/node/app/src
COPY --chown=node:node schemas /home/node/app/schemas
COPY --chown=node:node test /home/node/app/test
COPY --chown=node:node test-examples /home/node/app/test-examples
COPY --chown=node:node test-utils /home/node/app/test-utils
COPY --chown=node:node config /home/node/app/config
COPY --chown=node:node datadump/pre-population /home/node/app/datadump/pre-population
COPY --chown=node:node docker/entrypoint.sh /home/node/app/entrypoint.sh
RUN echo '{}' > /home/node/app/config/dev.json
RUN echo '{}' > /home/node/app/config/test.json
RUN echo '{}' > /home/node/app/config/staging.json

# Change db hostname from localhost to docdb for use inside docker
COPY docker/default.json-docker /home/node/app/config/default.json

EXPOSE 3000
ENTRYPOINT '/home/node/app/entrypoint.sh'
