# Using Docker with CVE Services

## Security Considerations

>**Warning**
>
>DO NOT use the dev configuration on a public network. The dev environment includes credentials to enable rapid development, and the MongoDB service config does not include authentication. This is not secure for public deployment.

## Local Development and Testing

The following builds and runs cve-services (Node.js app and Mongo) in Docker containers. The included example configurations run the services in `dev` or `int` mode.

>**Note**
>
> These commands must be run from the `docker/` directory.

### Environments

See the `.docker-env.example` and `.docker-env.int-example` files for examples of required environment variables. For development environments, it's important to define the following:

```
LOCAL_KEY=XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX
NODE_ENV=development
```

When using a development environment, the `LOCAL_KEY` is the API token key for the secretariat. In integration environments, the API keys will be written to a file named `user-secrets.txt` in the project directory.

### Start Docker Containers

1. Switch to the correct git branch. For penetration testing, use `int`. For local development, use `dev`.
2. Create your environment file if it doesn't already exist.
3. Run the containers (this will also build the cveawg container from the included Dockerfile).

```bash
cd docker/
git switch int
# use the integration environment
cp .docker-env.int-example .docker-env
docker compose up --build
```

Docker will build or update the containers if needed. In a few minutes, you should see something similar to the following:

```
[+] Running 3/3
 ⠿ Network docker_cve-services  Created
 ⠿ Container mongo              Created
 ⠿ Container cveawg             Created
Attaching to cveawg, mongo
mongo   | 2022-06-07T19:29:07.594+0000 I CONTROL  [initandlisten] MongoDB starting : pid=1 port=27017 dbpath=/data/db 64-bit host=551bb45dbadc
...
mongo   | 2022-06-07T19:29:08.106+0000 I NETWORK  [initandlisten] listening via socket bound to 0.0.0.0
mongo   | 2022-06-07T19:29:08.106+0000 I NETWORK  [initandlisten] listening via socket bound to /tmp/mongodb-27017.sock
mongo   | 2022-06-07T19:29:08.106+0000 I NETWORK  [initandlisten] waiting for connections on port 27017
...
cveawg  | > cve-services@0.0.3 start:dev /app
cveawg  | > node src/swagger.js && NODE_ENV=development node src/scripts/updateOpenapiHost.js && NODE_ENV=development node-dev src/index.js
...
cveawg  | 2022-06-07 19:29:10 [info]: "Using NODE_ENV 'development' and app environment 'development'"
cveawg  | 2022-06-07 19:29:11 [info]: "Using dbName = cve_dev"
...
cveawg  | 2022-06-07 19:29:11 [info]: "Successfully connected to database!"
cveawg  | 2022-06-07 19:29:11 [info]: "Serving on port 3000"
```

### Pre-load Data

Populate mongoDB with test data included in `datadump/pre-population/`

In another session on the host, run: 
```
docker-compose exec cveawg npm run populate:int
```

>**Note**
>
>Run either `populate:dev` or `populate:int` depending on your environment.

You should see the following:
```
> cve-services@0.0.3 populate:dev /app
> NODE_ENV=development node-dev src/scripts/populate.js

2022-06-07 19:58:32 [info]: "Using NODE_ENV 'development' and app environment 'development'"
2022-06-07 19:58:32 [info]: "Using dbName = cve_dev"
2022-06-07 19:58:32 [info]: "Will try to connect to database cve_dev at docdb:27017"
2022-06-07 19:58:32 [info]: "Successfully connected to database!"
Are you sure you wish to pre-populate the database for the development environment? Doing so will drop the Cve, Cve-Id-Range, Cve-Id, User, Org collection(s) in the cve_dev database. (y/n) y

2022-06-07 19:58:37 [info]: "Populating Org collection..."
2022-06-07 19:58:37 [info]: "Org populated!"
2022-06-07 19:58:37 [info]: "Populating User collection..."
2022-06-07 19:58:38 [info]: "User populated!"
2022-06-07 19:58:38 [info]: "Populating Cve-Id-Range collection..."
2022-06-07 19:58:38 [info]: "Populating Cve collection..."
2022-06-07 19:58:38 [info]: "Populating Cve-Id collection..."
2022-06-07 19:58:38 [info]: "Cve-Id-Range populated!"
2022-06-07 19:58:38 [info]: "Cve populated!"
2022-06-07 19:58:39 [info]: "Cve-Id populated!"
2022-06-07 19:58:39 [info]: "Successfully populated the database!"

```

### Use Curl to Test

#### Create a curl config file (recommended)

Create a curl config file in `$HOME/.curl-cve-config` similar to the following, where each line is a curl argument. In dev environments, use the value of the `LOCAL_KEY` environment variable (also output when pre-populating) as the API key.

```
-H "CVE-API-ORG: mitre"
-H "CVE-API-USER: admin2@mitre.org"
-H "CVE-API-KEY: XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX"
-H "Content-type: application/json"
-s
-S
```

#### Use curl to test the API endpoints

  * Show CVE IDs:
  `curl -K ~/.curl-cve-config http://localhost:3000/api/cve-id`

  * Retrieve organization info:
  `curl -K ~/.curl-cve-config http://localhost:3000/api/org`

  * Add a CNA
    `curl -K ~/.curl-cve-config -X POST \
      --data-binary '{"name": "Example Corporation","short_name": "exampleCorp"}' \
      http://localhost:3000/api/org`


>**Note**
>
>Each command returns unformatted JSON. Piping through a formatter like [JQ](https://stedolan.github.io/jq/) makes it easier to read: `curl -K ~/.curl-cve-config http://localhost:3000/api/cve-id | jq .`

## To shell into the web app server

  `docker compose exec cveawg /bin/sh`

## Viewing Mongo data

### Mongo Express

[Mongo Express](https://github.com/mongo-express/mongo-express) is a web-based viewer that can easily run in docker.

Start it with Docker using the same network and server as in `docker-compose.yml`:

  `docker run --network docker_cve-services -e ME_CONFIG_MONGODB_SERVER=docdb -p 8081:8081 mongo-express`

Open <http://localhost:8081> then select the `cve_dev` or `cve_stage` database.

## Use Compass

[Compass](https://www.mongodb.com/try/download/compass) is the official native Mongo GUI.

The default `docker-compose.yml` file exposes the default Mongo port so you can connect directly to `localhost:27017` with Compass.