const mongoose = require('mongoose')
const aggregatePaginate = require('mongoose-aggregate-paginate-v2')

const schema = {
  _id: false,
  time: {
    created: Date,
    modified: Date
  },
  cve: Object
}

const CveSchema = new mongoose.Schema(schema, { collection: 'Cve', timestamps: { createdAt: 'time.created', updatedAt: 'time.modified' } })

CveSchema.query.byCveId = function (cveId) {
  return this.where({ 'cve.cveMetadata.id': cveId })
}

CveSchema.plugin(aggregatePaginate)
const Cve = mongoose.model('Cve', CveSchema)

function createBaseCveMetadata(id, assigner, state) {
  const baseRecord = {
    dataType: 'CVE_RECORD',
    dataVersion: '5.0',
    cveMetadata: { id: id, assigner: assigner, state: state }
  }
  return baseRecord
}

CveSchema.methods.newRejectedCve = function newRejectedCve (id, assigner, state, descriptions, replacedBy) {
  const baseRecord = createBaseCveMetadata(id, assigner, state) // generate the base cve id

  const cnaRejectedContainer = {
    providerMetadata: { id },
    descriptions: { descriptions },
    replacedBy: { replacedBy }
  }

  const finalRecord = {
    baseRecord,
    containers: {
      cna: cnaRejectedContainer
    }
  }

  return this.finalRecord
}

module.exports = Cve
