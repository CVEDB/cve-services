const User = require('../model/user')
const cveSchema = require('./jsonSchema')
const logger = require('./logger')
const Djv = require('djv')
const env = new Djv()
const Validator = require('jsonschema').Validator
const v = new Validator()
const cveIdPattern = cveSchema.cveIdPattern
require('dotenv').config() // This enables us to read from the .env file

env.addSchema('cve', cveSchema.cveSchema5) // What is this used for?

const validateUser = (req, res, next) => {
  const cna = req.header('CVE-API-CNA')
  const submitter = req.header('CVE-API-SUBMITTER')
  const secret = req.header('CVE-API-SECRET')

  logger.info('Authenticating user: ' + submitter)

  User.findOne()
    .byUserName(submitter)
    .exec((err, result) => {
      if (err) {
        logger.error(err.stack)
        res.status(500).send('Internal Server Error')
      }

      if (result.cna_short_name !== cna || result.secret !== secret) {
        logger.warn('User authentication FAILED for ' + submitter)
        res.status(500).send('User Authentication FAILED')
      }

      logger.info('SUCCESSFUL user authentication for ' + submitter)
      next()
    })
}

const validateURLs = (req, res, next) => {
  logger.info('Validating URL')

  const validURLs = [
    /^\/api\/cve\/?$/i,
    /^(\/api\/cve\/)(\S*)$/i,
    /^\/api\/planets\/?$/i, // for testing only
    /^(\/api\/planets\/)(\S*)$/i // for testing only
  ]

  if (process.env.NODE_ENV === 'dev') {
    validURLs.push(/^\/mongo\/user\/?$/i) // dev only
    validURLs.push(/^\/mongo\/user\/\S*$/i) // dev only
    validURLs.push(/^\/mongo\/cna\/?$/i) // dev only
    validURLs.push(/^\/mongo\/cna\/\S*$/i) // dev only
  }

  let index = -1
  let id

  for (let i = 0; i < validURLs.length; i++) {
    const result = req.url.match(validURLs[i])

    if (result) {
      index = i
      id = result[2]
      break
    }
  }

  if (index < 0) {
    logger.warn('Unknown URL - URL Validation FAILED')
    res.status(404).send('Unknown URL')
  }

  // api/cve/:id
  if (index === 1 && id) {
    if (id.match(cveIdPattern)) {
      logger.info('SUCCESSFUL URL validation')
      next()
    } else {
      logger.warn('Wrong CVE ID format in URL - URL Validation FAILED')
      res.status(400).send('Wrong CVE ID format in URL')
    }
  } else {
    // TODO: Validate URL parameters for URLs other than api/cve/:id

    logger.info('SUCCESSFUL URL validation')
    next()
  }
}

// TODO: Request body sanitation, better user messages, and use correct status codes
const validateCveJsonSchema = (req, res, next) => {
  const cve = req.body

  if (req.method === 'POST') {
    logger.info('Validating CVE JSON schema')

    const schema4 = cveSchema.cveSchema4
    const result = v.validate(cve, schema4)
    // const schema5 = cveSchema.cveSchema5
    // const result = v.validate(cve, schema5)

    if (result.valid) {
      logger.info('SUCCESSFUL CVE JSON schema validation')
      next()
    } else {
      logger.error(result)
      logger.error('CVE JSON schema validation FAILED')

      res.status(400).send('CVE JSON schema validation FAILED.\n' + result)
    }
  } else if (req.method === 'GET') {
    next()
  } else {
    res.status(400).send('CVE JSON schema validation FAILED')
  }
}

module.exports = {
  validateUser,
  validateURLs,
  validateCveJsonSchema
}
