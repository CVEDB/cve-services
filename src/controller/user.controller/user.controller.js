require('dotenv').config()
// const User = require('../../model/user')
// const Org = require('../../model/org')
const logger = require('../../middleware/logger')
// const argon2 = require('argon2')
const CONSTANTS = require('../../constants')
// const cryptoRandomString = require('crypto-random-string')
// const uuid = require('uuid')
// const errors = require('./error')
// const error = new errors.UserControllerError()

// Get the details of all orgs
async function getAllUsers (req, res, next) {
  try {
    const options = CONSTANTS.PAGINATOR_OPTIONS
    options.sort = { short_name: 'asc' }
    options.page = req.ctx.query.page ? parseInt(req.ctx.query.page) : CONSTANTS.PAGINATOR_PAGE // if 'page' query parameter is not defined, set 'page' to the default page value
    const repo = req.ctx.repositories.getOrgRepository()

    const agt = setAggregateOrgObj({})
    const pg = await repo.aggregatePaginate(agt, options)
    const payload = { organizations: pg.itemsList }

    if (pg.itemCount >= CONSTANTS.PAGINATOR_OPTIONS.limit) {
      payload.totalCount = pg.itemCount
      payload.itemsPerPage = pg.itemsPerPage
      payload.pageCount = pg.pageCount
      payload.currentPage = pg.currentPage
      payload.prevPage = pg.prevPage
      payload.nextPage = pg.nextPage
    }

    logger.info({ uuid: req.ctx.uuid, message: 'The users information was sent to the user.' })
    return res.status(200).json(payload)
  } catch (err) {
    next(err)
  }
}

function setAggregateOrgObj (query) {
  return [
    {
      $match: query
    },
    {
      $project: {
        _id: false,
        UUID: true,
        short_name: true,
        name: true,
        'authority.active_roles': true,
        'policies.id_quota': true,
        time: true
      }
    }
  ]
}

module.exports = {
  ALL_USERS: getAllUsers
}
